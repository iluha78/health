# Бэкенд проекта CholestoFit

## Подготовка окружения

1. Скопируйте файл переменных окружения и задайте собственные значения:
   ```bash
   cp .env.example .env
   ```
2. Установите зависимости:
   ```bash
   composer install
   ```
3. Запустите контейнеры из корня репозитория (если используете Docker Compose):
   ```bash
   docker-compose up -d
   ```
   По умолчанию внешний порт базы данных пробрасывается на `3307`, чтобы не конфликтовать с локально установленным MySQL. При необходимости задайте собственное значение через переменную окружения `MYSQL_HOST_PORT` перед запуском `docker-compose`.

## Запуск миграций

После настройки доступа к базе данных выполните:

```bash
composer migrate
```

Скрипт `bin/migrate.php` прочитает все `.sql` файлы из каталога `migrations`, выполнит только те, что ещё не применялись, и добавит запись в таблицу `schema_migrations`. Повторный запуск безопасен — уже применённые файлы будут пропущены.

Если требуется указать собственные параметры подключения, задайте их в `.env`:

```
DB_HOST=127.0.0.1
DB_PORT=3306
DB_NAME=cholestofit
DB_USER=root
DB_PASS=secret
```

### Автоматический запуск миграций

По умолчанию при старте HTTP-приложения бэкенд пытается применить все неприменённые миграции. То же самое делает Docker-образ перед запуском встроенного сервера. Поведение управляется флагом `AUTO_RUN_MIGRATIONS` (он добавлен в `.env.example`). Установите `AUTO_RUN_MIGRATIONS=false`, если хотите полностью контролировать запуск миграций вручную.

Для контейнерного запуска можно задать дополнительные параметры:

- `MIGRATION_MAX_RETRIES` — сколько раз повторять миграции перед ошибкой (по умолчанию 10);
- `MIGRATION_RETRY_DELAY` — пауза между попытками в секундах (по умолчанию 3).

Это позволяет дождаться готовности MySQL и не завершать контейнер сразу при первой неудачной попытке.

## Настройка CORS

По умолчанию сервер отвечает на междоменные запросы с любого источника. Чтобы ограничить список доменов, укажите их в `.env` через запятую:

```
CORS_ALLOWED_ORIGINS=http://localhost:5173,https://example.com
```

Допускается опускать схему — в этом случае используется HTTP. Если не указать порт, разрешатся любые порты для выбранного хоста (удобно для контейнеров, где фронтенд может работать на 3000/4173/5173 и т. п.).

Для локальной разработки адреса `localhost`, `127.0.0.1`, `0.0.0.0` и `host.docker.internal` дополнительно допускаются автоматически — даже при строгом списке разрешённых origin браузер с хост-машины сможет обратиться к API. Указание одного из этих адресов также автоматически добавляет зеркала (например, `localhost` → `127.0.0.1` и `host.docker.internal`).

Если схема указана как `http` или `https`, для локальных адресов будет принят и альтернативный вариант (например, `https://localhost:5173` позволит также `http://localhost:5173`). Это избавляет от ошибок при переключении между HTTP/HTTPS в контейнерах.

Для предзапросов (метод `OPTIONS`) сервер возвращает статус `204` с необходимыми заголовками, после чего браузер выполнит основной запрос `POST/GET/...` при совпадении origin.

## Откат миграций

На текущий момент откат не реализован. Чтобы изменить структуру, создайте новую миграцию с корректирующими SQL-командами.
