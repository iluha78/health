# Бэкенд проекта CholestoFit

## Подготовка окружения

1. Скопируйте файл переменных окружения и задайте собственные значения:
   ```bash
   cp .env.example .env
   ```
2. Установите зависимости:
   ```bash
   composer install
   ```
3. Запустите контейнеры из корня репозитория (если используете Docker Compose):
   ```bash
   docker-compose up -d
   ```
   По умолчанию внешний порт базы данных пробрасывается на `3307`, чтобы не конфликтовать с локально установленным MySQL. При необходимости задайте собственное значение через переменную окружения `MYSQL_HOST_PORT` перед запуском `docker-compose`.

## Запуск миграций

После настройки доступа к базе данных выполните:

```bash
composer migrate
```

Скрипт `bin/migrate.php` прочитает все `.sql` файлы из каталога `migrations`, выполнит только те, что ещё не применялись, и добавит запись в таблицу `schema_migrations`. Повторный запуск безопасен — уже применённые файлы будут пропущены.

Если требуется указать собственные параметры подключения, задайте их в `.env`:

```
DB_HOST=127.0.0.1
DB_PORT=3306
DB_NAME=cholestofit
DB_USER=root
DB_PASS=secret
```

### Настройка почты

Для отправки писем с кодами подтверждения и восстановления пароля задайте обратный адрес и имя отправителя:

```
MAIL_FROM_ADDRESS=no-reply@example.com
MAIL_FROM_NAME="CholestoFit"
```

По умолчанию используется драйвер `log`, который не отправляет письма, а сохраняет их содержимое в файл `storage/logs/mail.log` (путь указан относительно каталога `backend`). Это удобно для локальной разработки. Чтобы включить реальную отправку через функцию `mail`, установите переменную окружения:

```
MAIL_DRIVER=mail
```

Если необходимо очистить журнал, просто удалите файл `mail.log` (он будет создан вновь при следующей отправке). При использовании драйвера `mail` важно корректно настроить системный MTA, иначе отправка завершится ошибкой.

Для отправки через SMTP задайте:

```
MAIL_DRIVER=smtp
MAIL_SMTP_HOST=smtp.example.com
MAIL_SMTP_PORT=587
MAIL_SMTP_ENCRYPTION=tls # допустимые варианты: tls/starttls, ssl, none
MAIL_SMTP_AUTH=true
MAIL_SMTP_USERNAME=your-login
MAIL_SMTP_PASSWORD=your-password
MAIL_SMTP_TIMEOUT=30
MAIL_SMTP_EHLO_DOMAIN=localhost
MAIL_SMTP_TLS_VERIFY_PEER=true
MAIL_SMTP_TLS_VERIFY_PEER_NAME=true
MAIL_SMTP_TLS_ALLOW_SELF_SIGNED=false
MAIL_SMTP_TLS_CAFILE=/path/to/cacert.pem
MAIL_SMTP_TLS_CAPATH=/path/to/cadir
```

Если SMTP-сервер не требует авторизации, установите `MAIL_SMTP_AUTH=false`. При значении `MAIL_SMTP_ENCRYPTION=none` шифрование будет отключено (и автоматическое повышение до TLS также), для SMTPS используйте `ssl`, для StartTLS — `tls` или `starttls`.
При необходимости скорректируйте таймаут подключения через `MAIL_SMTP_TIMEOUT` (значение в секундах) и укажите домен, который будет отправлен в команде `EHLO`, через `MAIL_SMTP_EHLO_DOMAIN`.

Для управления проверкой сертификатов TLS доступны дополнительные переменные окружения:

- `MAIL_SMTP_TLS_VERIFY_PEER` — включить/отключить проверку сертификата сервера (по умолчанию `true`);
- `MAIL_SMTP_TLS_VERIFY_PEER_NAME` — проверять соответствие имени хоста сертификату (по умолчанию `true`);
- `MAIL_SMTP_TLS_ALLOW_SELF_SIGNED` — разрешить самоподписанные сертификаты (`false` по умолчанию);
- `MAIL_SMTP_TLS_CAFILE`/`MAIL_SMTP_TLS_CAPATH` — путь к кастомному файлу/каталогу доверенных сертификатов, если стандартное хранилище не содержит цепочку вашего SMTP.

Если TLS-рукопожатие завершается ошибкой проверки сертификата, вы можете временно отключить проверку (`MAIL_SMTP_TLS_VERIFY_PEER=false`) или указать собственный список доверенных сертификатов через `MAIL_SMTP_TLS_CAFILE`, чтобы корректно подключиться к серверу с самоподписанным сертификатом.

> **Подсказка.** При активном драйвере `log` API дополнительно возвращает сам код подтверждения/восстановления в тексте ответа, чтобы вы могли сразу завершить сценарий даже без просмотра файла журнала.

### Автоматический запуск миграций

По умолчанию при старте HTTP-приложения бэкенд пытается применить все неприменённые миграции. То же самое делает Docker-образ перед запуском встроенного сервера. Поведение управляется флагом `AUTO_RUN_MIGRATIONS` (он добавлен в `.env.example`). Установите `AUTO_RUN_MIGRATIONS=false`, если хотите полностью контролировать запуск миграций вручную.

Для контейнерного запуска можно задать дополнительные параметры:

- `MIGRATION_MAX_RETRIES` — сколько раз повторять миграции перед ошибкой (по умолчанию 10);
- `MIGRATION_RETRY_DELAY` — пауза между попытками в секундах (по умолчанию 3).

Это позволяет дождаться готовности MySQL и не завершать контейнер сразу при первой неудачной попытке.

## Настройка CORS

По умолчанию сервер отвечает на междоменные запросы с любого источника. Чтобы ограничить список доменов, укажите их в `.env` через запятую:

```
CORS_ALLOWED_ORIGINS=http://localhost:5173,https://example.com
```

Допускается опускать схему — в этом случае используется HTTP. Если не указать порт, разрешатся любые порты для выбранного хоста (удобно для контейнеров, где фронтенд может работать на 3000/4173/5173 и т. п.).

Для локальной разработки адреса `localhost`, `127.0.0.1`, `0.0.0.0` и `host.docker.internal` дополнительно допускаются автоматически — даже при строгом списке разрешённых origin браузер с хост-машины сможет обратиться к API. Указание одного из этих адресов также автоматически добавляет зеркала (например, `localhost` → `127.0.0.1` и `host.docker.internal`).

Если схема указана как `http` или `https`, для локальных адресов будет принят и альтернативный вариант (например, `https://localhost:5173` позволит также `http://localhost:5173`). Это избавляет от ошибок при переключении между HTTP/HTTPS в контейнерах.

Для предзапросов (метод `OPTIONS`) сервер возвращает статус `204` с необходимыми заголовками, после чего браузер выполнит основной запрос `POST/GET/...` при совпадении origin.

## Откат миграций

На текущий момент откат не реализован. Чтобы изменить структуру, создайте новую миграцию с корректирующими SQL-командами.
