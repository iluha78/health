# Бэкенд проекта CholestoFit

## Подготовка окружения

1. Скопируйте файл переменных окружения и задайте собственные значения:
   ```bash
   cp .env.example .env
   ```
2. Установите зависимости:
   ```bash
   composer install
   ```
3. Запустите контейнеры из корня репозитория (если используете Docker Compose):
   ```bash
   docker-compose up -d
   ```
   По умолчанию внешний порт базы данных пробрасывается на `3307`, чтобы не конфликтовать с локально установленным MySQL. При необходимости задайте собственное значение через переменную окружения `MYSQL_HOST_PORT` перед запуском `docker-compose`.

## Запуск миграций

После настройки доступа к базе данных выполните:

```bash
composer migrate
```

Скрипт `bin/migrate.php` прочитает все `.sql` файлы из каталога `migrations`, выполнит только те, что ещё не применялись, и добавит запись в таблицу `schema_migrations`. Повторный запуск безопасен — уже применённые файлы будут пропущены.

Если требуется указать собственные параметры подключения, задайте их в `.env`:

```
DB_HOST=127.0.0.1
DB_PORT=3306
DB_NAME=cholestofit
DB_USER=root
DB_PASS=secret
```

### Автоматический запуск миграций

По умолчанию при старте HTTP-приложения бэкенд пытается применить все неприменённые миграции. То же самое делает Docker-образ перед запуском встроенного сервера. Поведение управляется флагом `AUTO_RUN_MIGRATIONS` (он добавлен в `.env.example`). Установите `AUTO_RUN_MIGRATIONS=false`, если хотите полностью контролировать запуск миграций вручную.

## Настройка CORS

По умолчанию сервер отвечает на междоменные запросы с любого источника. Чтобы ограничить список доменов, укажите их в `.env` через запятую:

```
CORS_ALLOWED_ORIGINS=http://localhost:5173,https://example.com
```

Для предзапросов (метод `OPTIONS`) сервер возвращает статус `204` с необходимыми заголовками, после чего браузер выполнит основной запрос `POST/GET/...` при совпадении origin.

## Откат миграций

На текущий момент откат не реализован. Чтобы изменить структуру, создайте новую миграцию с корректирующими SQL-командами.
